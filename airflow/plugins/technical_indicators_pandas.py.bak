#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
import sys
import pandas as pd
import numpy as np
from typing import Dict, Any, List, Optional

# í”„ë¡œì íŠ¸ ê²½ë¡œ ì¶”ê°€
sys.path.insert(0, '/opt/airflow')

from common.database import DuckDBManager

class TechnicalIndicators:
    """ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚° í´ëž˜ìŠ¤ (Pandas ê¸°ë°˜)"""
    
    def __init__(self, db_path: str = "/data/duckdb/stock_data.db"):
        """
        ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚° í´ëž˜ìŠ¤ ì´ˆê¸°í™”
        
        Args:
            db_path: DuckDB íŒŒì¼ ê²½ë¡œ
        """
        self.db = DuckDBManager(db_path)
        self.spark = self._create_spark_session()
    
    def _create_spark_session(self) -> SparkSession:
        """
        ìŠ¤íŒŒí¬ ì„¸ì…˜ ìƒì„±
        
        Returns:
            SparkSession ì¸ìŠ¤í„´ìŠ¤
        """
        return (SparkSession.builder
                .appName("StockTechnicalIndicators")
                .config("spark.driver.memory", "2g")
                .config("spark.executor.memory", "2g")
                .getOrCreate())
    
    def load_stock_data(self, symbol: Optional[str] = None) -> pd.DataFrame:
        """
        ì£¼ê°€ ë°ì´í„° ë¡œë“œ
        
        Args:
            symbol: ì¢…ëª© ì‹¬ë³¼ (Noneì´ë©´ ëª¨ë“  ì¢…ëª©)
            
        Returns:
            ì£¼ê°€ ë°ì´í„° DataFrame
        """
        if symbol:
            query = f"""
                SELECT * FROM stock_data
                WHERE symbol = '{symbol}'
                ORDER BY date
            """
        else:
            query = """
                SELECT * FROM stock_data
                ORDER BY symbol, date
            """
        
        result = self.db.conn.execute(query).fetchall()
        columns = ["symbol", "date", "open", "high", "low", "close", "volume"]
        df = pd.DataFrame(result, columns=columns)
        
        return df
    
    def calculate_indicators(self, symbol: Optional[str] = None):
        """
        ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚° ë° ì €ìž¥
        
        Args:
            symbol: ì¢…ëª© ì‹¬ë³¼ (Noneì´ë©´ ëª¨ë“  ì¢…ëª©)
        """
        # ì£¼ê°€ ë°ì´í„° ë¡œë“œ
        stock_data = self.load_stock_data(symbol)
        
        if stock_data.empty:
            print(f"âš ï¸ {'ëª¨ë“  ì¢…ëª©' if symbol is None else symbol}ì˜ ì£¼ê°€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
            return
        
        print(f"ðŸ” {'ëª¨ë“  ì¢…ëª©' if symbol is None else symbol}ì˜ ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚° ì‹œìž‘")
        
        # ìŠ¤íŒŒí¬ ë°ì´í„°í”„ë ˆìž„ìœ¼ë¡œ ë³€í™˜
        spark_df = self.spark.createDataFrame(stock_data)
        
        # ì¢…ëª©ë³„ ìœˆë„ìš° ì •ì˜
        window_spec = Window.partitionBy("symbol").orderBy("date")
        
        # 1. ì´ë™í‰ê· ì„  (SMA)
        for period in [5, 20, 60, 112, 224, 448]:
            window_avg = Window.partitionBy("symbol").orderBy("date").rowsBetween(-(period-1), 0)
            spark_df = spark_df.withColumn(f"sma_{period}", avg("close").over(window_avg))
        
        # 2. ì§€ìˆ˜ì´ë™í‰ê·  (EMA)
        # SMAë¡œ ì´ˆê¸°ê°’ ì„¤ì • í›„ ì§ì ‘ ê³„ì‚°
        for period in [5, 20, 60]:
            spark_df = self._calculate_ema(spark_df, period)
        
        # 3. ë³¼ë¦°ì € ë°´ë“œ (ê¸°ì¤€: 20ì¼ ì´ë™í‰ê· , í‘œì¤€íŽ¸ì°¨ 2)
        window_std = Window.partitionBy("symbol").orderBy("date").rowsBetween(-19, 0)
        spark_df = spark_df.withColumn("bb_middle", col("sma_20"))
        spark_df = spark_df.withColumn("bb_std", stddev("close").over(window_std))
        spark_df = spark_df.withColumn("bb_upper", col("bb_middle") + (col("bb_std") * 2))
        spark_df = spark_df.withColumn("bb_lower", col("bb_middle") - (col("bb_std") * 2))
        
        # 4. MACD (12ì¼ EMA, 26ì¼ EMA, 9ì¼ ì‹ í˜¸ì„ )
        spark_df = self._calculate_ema(spark_df, 12, "ema_12")
        spark_df = self._calculate_ema(spark_df, 26, "ema_26")
        spark_df = spark_df.withColumn("macd", col("ema_12") - col("ema_26"))
        
        # MACD ì‹ í˜¸ì„  (9ì¼ EMA)
        window_signal = Window.partitionBy("symbol").orderBy("date")
        spark_df = spark_df.withColumn("macd_signal", 
                                       expr("avg(macd) OVER (PARTITION BY symbol ORDER BY date ROWS BETWEEN 8 PRECEDING AND CURRENT ROW)"))
        spark_df = spark_df.withColumn("macd_histogram", col("macd") - col("macd_signal"))
        
        # 5. RSI (14ì¼)
        spark_df = self._calculate_rsi(spark_df, 14)
        
        # 6. CCI (ìƒí’ˆì±„ë„ì§€ìˆ˜, 20ì¼)
        spark_df = self._calculate_cci(spark_df, 20)
        
        # 7. OBV (On Balance Volume)
        spark_df = self._calculate_obv(spark_df)
        
        # í•„ìš”í•œ ì—´ë§Œ ì„ íƒí•˜ì—¬ ìµœì¢… ê²°ê³¼ ìƒì„±
        result_df = spark_df.select(
            "symbol", "date", 
            "bb_upper", "bb_middle", "bb_lower",
            "macd", "macd_signal", "macd_histogram",
            "rsi",
            "sma_5", "sma_20", "sma_60",
            "ema_5", "ema_20", "ema_60",
            "cci", "obv",
            col("sma_112").alias("ma_112"),
            col("sma_224").alias("ma_224"),
            col("sma_448").alias("ma_448")
        )
        
        # ê²°ê³¼ë¥¼ íŒë‹¤ìŠ¤ ë°ì´í„°í”„ë ˆìž„ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ DuckDBì— ì €ìž¥
        pandas_df = result_df.toPandas()
        
        # NaN ê°’ì„ Noneìœ¼ë¡œ ë³€í™˜
        pandas_df = pandas_df.where(pd.notnull(pandas_df), None)
        
        # DuckDBì— ì €ìž¥
        saved_count = 0
        for _, row in pandas_df.iterrows():
            try:
                self.db.save_technical_indicators(row.to_dict())
                saved_count += 1
            except Exception as e:
                print(f"âŒ ê¸°ìˆ ì  ì§€í‘œ ì €ìž¥ ì˜¤ë¥˜: {e}")
        
        print(f"âœ… ê¸°ìˆ ì  ì§€í‘œ {saved_count}ê°œ ì €ìž¥ ì™„ë£Œ")
    
    def _calculate_ema(self, df, period, col_name=None):
        """
        ì§€ìˆ˜ì´ë™í‰ê·  ê³„ì‚°
        
        Args:
            df: ìŠ¤íŒŒí¬ ë°ì´í„°í”„ë ˆìž„
            period: ê¸°ê°„
            col_name: ê²°ê³¼ ì—´ ì´ë¦„
            
        Returns:
            EMA ì—´ì´ ì¶”ê°€ëœ ë°ì´í„°í”„ë ˆìž„
        """
        if col_name is None:
            col_name = f"ema_{period}"
            
        # ì´ˆê¸°ê°’ìœ¼ë¡œ SMA ì‚¬ìš©
        window_avg = Window.partitionBy("symbol").orderBy("date").rowsBetween(-(period-1), 0)
        df = df.withColumn(f"{col_name}_init", avg("close").over(window_avg))
        
        # ê°€ì¤‘ì¹˜ ê³„ì‚°
        alpha = 2.0 / (period + 1.0)
        
        # EMA ê³„ì‚°
        return df.withColumn(col_name, 
                             when(col("close").isNull(), None)
                             .otherwise(expr(f"""
                                 CASE 
                                     WHEN {col_name}_init IS NULL THEN NULL
                                     ELSE {col_name}_init * (1 - {alpha}) + close * {alpha} 
                                 END
                             """)))
    
    def _calculate_rsi(self, df, period=14):
        """
        RSI(Relative Strength Index) ê³„ì‚°
        
        Args:
            df: ìŠ¤íŒŒí¬ ë°ì´í„°í”„ë ˆìž„
            period: ê¸°ê°„
            
        Returns:
            RSI ì—´ì´ ì¶”ê°€ëœ ë°ì´í„°í”„ë ˆìž„
        """
        # ì „ì¼ ì¢…ê°€ ê³„ì‚°
        window_lag = Window.partitionBy("symbol").orderBy("date")
        df = df.withColumn("prev_close", lag("close", 1).over(window_lag))
        
        # ìƒìŠ¹í­ê³¼ í•˜ë½í­ ê³„ì‚°
        df = df.withColumn("price_diff", col("close") - col("prev_close"))
        df = df.withColumn("gain", when(col("price_diff") > 0, col("price_diff")).otherwise(0))
        df = df.withColumn("loss", when(col("price_diff") < 0, -col("price_diff")).otherwise(0))
        
        # ì´ë™í‰ê·  ê³„ì‚°
        window_avg = Window.partitionBy("symbol").orderBy("date").rowsBetween(-(period-1), 0)
        df = df.withColumn("avg_gain", avg("gain").over(window_avg))
        df = df.withColumn("avg_loss", avg("loss").over(window_avg))
        
        # RSI ê³„ì‚°
        df = df.withColumn("rs", col("avg_gain") / col("avg_loss"))
        df = df.withColumn("rsi", 100 - (100 / (1 + col("rs"))))
        
        return df
    
    def _calculate_cci(self, df, period=20):
        """
        CCI(Commodity Channel Index) ê³„ì‚°
        
        Args:
            df: ìŠ¤íŒŒí¬ ë°ì´í„°í”„ë ˆìž„
            period: ê¸°ê°„
            
        Returns:
            CCI ì—´ì´ ì¶”ê°€ëœ ë°ì´í„°í”„ë ˆìž„
        """
        # ì „í˜•ì  ê°€ê²© ê³„ì‚° (ê³ ê°€ + ì €ê°€ + ì¢…ê°€) / 3
        df = df.withColumn("typical_price", (col("high") + col("low") + col("close")) / 3)
        
        # ì´ë™í‰ê·  ê³„ì‚°
        window_avg = Window.partitionBy("symbol").orderBy("date").rowsBetween(-(period-1), 0)
        df = df.withColumn("tp_sma", avg("typical_price").over(window_avg))
        
        # íŽ¸ì°¨ì˜ ì ˆëŒ€ê°’ í‰ê·  ê³„ì‚°
        df = df.withColumn("mean_deviation", 
                           expr(f"avg(abs(typical_price - tp_sma)) OVER (PARTITION BY symbol ORDER BY date ROWS BETWEEN {-(period-1)} PRECEDING AND CURRENT ROW)"))
        
        # CCI ê³„ì‚° (0.015ëŠ” ìƒìˆ˜)
        df = df.withColumn("cci", (col("typical_price") - col("tp_sma")) / (0.015 * col("mean_deviation")))
        
        return df
    
    def _calculate_obv(self, df):
        """
        OBV(On Balance Volume) ê³„ì‚°
        
        Args:
            df: ìŠ¤íŒŒí¬ ë°ì´í„°í”„ë ˆìž„
            
        Returns:
            OBV ì—´ì´ ì¶”ê°€ëœ ë°ì´í„°í”„ë ˆìž„
        """
        # ì „ì¼ ì¢…ê°€ ê³„ì‚°
        window = Window.partitionBy("symbol").orderBy("date")
        df = df.withColumn("prev_close", lag("close", 1).over(window))
        
        # OBV ê³„ì‚° ê·œì¹™
        df = df.withColumn("obv_value", 
                           when(col("close") > col("prev_close"), col("volume"))
                           .when(col("close") < col("prev_close"), -col("volume"))
                           .otherwise(0))
        
        # ëˆ„ì í•© ê³„ì‚°
        df = df.withColumn("obv", sum("obv_value").over(window))
        
        return df
    
    def close(self):
        """ë¦¬ì†ŒìŠ¤ ì •ë¦¬"""
        self.db.close()
        self.spark.stop()

# ì—ì–´í”Œë¡œìš°ì—ì„œ í˜¸ì¶œí•˜ëŠ” í•¨ìˆ˜
def calculate_technical_indicators_task(**kwargs):
    """
    ì—ì–´í”Œë¡œìš° íƒœìŠ¤í¬ í•¨ìˆ˜: ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚°
    
    Args:
        **kwargs: ì—ì–´í”Œë¡œìš° ì»¨í…ìŠ¤íŠ¸
        
    Returns:
        ì„±ê³µ ì—¬ë¶€
    """
    indicators = TechnicalIndicators()
    
    try:
        # ëª¨ë“  ì¢…ëª©ì— ëŒ€í•´ ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚°
        indicators.calculate_indicators()
        indicators.close()
        return True
    
    except Exception as e:
        indicators.close()
        print(f"âŒ ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚° ì˜¤ë¥˜: {e}")
        return False
