#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
import sys
import pandas as pd
import numpy as np
from typing import Dict, Any, List, Optional

# í”„ë¡œì íŠ¸ ê²½ë¡œ ì¶”ê°€
sys.path.insert(0, '/opt/airflow')

from common.database import DuckDBManager

class TechnicalIndicators:
    """ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚° í´ë˜ìŠ¤ (Pandas ê¸°ë°˜) - DuckDB ë²„ì „"""
    
    def __init__(self, db_path: str = "/data/duckdb/stock_data.db"):
        """
        ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚° í´ë˜ìŠ¤ ì´ˆê¸°í™” - DuckDB ë²„ì „
        
        Args:
            db_path: DuckDB íŒŒì¼ ê²½ë¡œ
        """
        self.db = DuckDBManager(db_path=db_path)
    
    def calculate_bollinger_bands(self, symbol: str, period: int = 20, std_dev: float = 2.0) -> pd.DataFrame:
        """
        ë³¼ë¦°ì € ë°´ë“œ ê³„ì‚°
        
        Args:
            symbol: ì¢…ëª© ì‹¬ë³¼
            period: ì´ë™í‰ê·  ê¸°ê°„ (ê¸°ë³¸ 20ì¼)
            std_dev: í‘œì¤€í¸ì°¨ ë°°ìˆ˜ (ê¸°ë³¸ 2.0)
        """
        # ì£¼ê°€ ë°ì´í„° ì¡°íšŒ
        query = """
        SELECT symbol, date, close
        FROM stock_data 
        WHERE symbol = ?
        ORDER BY date
        """
        
        df = pd.read_sql_query(query, self.db.conn, params=[symbol])
        
        if df.empty:
            return df
        
        # ë³¼ë¦°ì € ë°´ë“œ ê³„ì‚°
        df['bb_middle'] = df['close'].rolling(window=period).mean()
        df['bb_std'] = df['close'].rolling(window=period).std()
        df['bb_upper'] = df['bb_middle'] + (df['bb_std'] * std_dev)
        df['bb_lower'] = df['bb_middle'] - (df['bb_std'] * std_dev)
        
        return df
    
    def calculate_rsi(self, symbol: str, period: int = 14) -> pd.DataFrame:
        """
        RSI (Relative Strength Index) ê³„ì‚°
        
        Args:
            symbol: ì¢…ëª© ì‹¬ë³¼
            period: RSI ê³„ì‚° ê¸°ê°„ (ê¸°ë³¸ 14ì¼)
        """
        # ì£¼ê°€ ë°ì´í„° ì¡°íšŒ
        query = """
        SELECT symbol, date, close
        FROM stock_data 
        WHERE symbol = ?
        ORDER BY date
        """
        
        df = pd.read_sql_query(query, self.db.conn, params=[symbol])
        
        if df.empty:
            return df
        
        # ê°€ê²© ë³€í™” ê³„ì‚°
        df['price_change'] = df['close'].diff()
        df['gain'] = df['price_change'].where(df['price_change'] > 0, 0)
        df['loss'] = (-df['price_change']).where(df['price_change'] < 0, 0)
        
        # í‰ê·  ìƒìŠ¹/í•˜ë½ ê³„ì‚°
        df['avg_gain'] = df['gain'].rolling(window=period).mean()
        df['avg_loss'] = df['loss'].rolling(window=period).mean()
        
        # RSI ê³„ì‚°
        df['rs'] = df['avg_gain'] / df['avg_loss']
        df['rsi'] = 100 - (100 / (1 + df['rs']))
        
        return df
    
    def calculate_macd(self, symbol: str, fast_period: int = 12, slow_period: int = 26, signal_period: int = 9) -> pd.DataFrame:
        """
        MACD ê³„ì‚°
        
        Args:
            symbol: ì¢…ëª© ì‹¬ë³¼
            fast_period: ë¹ ë¥¸ EMA ê¸°ê°„ (ê¸°ë³¸ 12ì¼)
            slow_period: ëŠë¦° EMA ê¸°ê°„ (ê¸°ë³¸ 26ì¼)
            signal_period: ì‹œê·¸ë„ ë¼ì¸ ê¸°ê°„ (ê¸°ë³¸ 9ì¼)
        """
        # ì£¼ê°€ ë°ì´í„° ì¡°íšŒ
        query = """
        SELECT symbol, date, close
        FROM stock_data 
        WHERE symbol = ?
        ORDER BY date
        """
        
        df = pd.read_sql_query(query, self.db.conn, params=[symbol])
        
        if df.empty:
            return df
        
        # EMA ê³„ì‚°
        df['ema_fast'] = df['close'].ewm(span=fast_period).mean()
        df['ema_slow'] = df['close'].ewm(span=slow_period).mean()
        
        # MACD ê³„ì‚°
        df['macd'] = df['ema_fast'] - df['ema_slow']
        df['macd_signal'] = df['macd'].ewm(span=signal_period).mean()
        df['macd_histogram'] = df['macd'] - df['macd_signal']
        
        return df
    
    def calculate_moving_averages(self, symbol: str, periods: List[int] = [5, 20, 60]) -> pd.DataFrame:
        """
        ì´ë™í‰ê·  ê³„ì‚°
        
        Args:
            symbol: ì¢…ëª© ì‹¬ë³¼
            periods: ì´ë™í‰ê·  ê¸°ê°„ ë¦¬ìŠ¤íŠ¸
        """
        # ì£¼ê°€ ë°ì´í„° ì¡°íšŒ
        query = """
        SELECT symbol, date, close
        FROM stock_data 
        WHERE symbol = ?
        ORDER BY date
        """
        
        df = pd.read_sql_query(query, self.db.conn, params=[symbol])
        
        if df.empty:
            return df
        
        # SMA ê³„ì‚°
        for period in periods:
            df[f'sma_{period}'] = df['close'].rolling(window=period).mean()
            df[f'ema_{period}'] = df['close'].ewm(span=period).mean()
        
        return df
    
    def calculate_all_indicators(self, symbol: str) -> Dict[str, Any]:
        """
        ëª¨ë“  ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚°
        
        Args:
            symbol: ì¢…ëª© ì‹¬ë³¼
            
        Returns:
            ê³„ì‚°ëœ ì§€í‘œë“¤ì˜ ë”•ì…”ë„ˆë¦¬
        """
        try:
            # ê¸°ë³¸ ì£¼ê°€ ë°ì´í„° ì¡°íšŒ
            query = """
            SELECT symbol, date, open, high, low, close, volume
            FROM stock_data 
            WHERE symbol = ?
            ORDER BY date
            """
            
            df = pd.read_sql_query(query, self.db.conn, params=[symbol])
            
            if df.empty:
                return {}
            
            # ë³¼ë¦°ì € ë°´ë“œ
            bb_data = self.calculate_bollinger_bands(symbol)
            if not bb_data.empty:
                df = df.merge(bb_data[['date', 'bb_upper', 'bb_middle', 'bb_lower']], on='date', how='left')
            
            # RSI
            rsi_data = self.calculate_rsi(symbol)
            if not rsi_data.empty:
                df = df.merge(rsi_data[['date', 'rsi']], on='date', how='left')
            
            # MACD
            macd_data = self.calculate_macd(symbol)
            if not macd_data.empty:
                df = df.merge(macd_data[['date', 'macd', 'macd_signal', 'macd_histogram']], on='date', how='left')
            
            # ì´ë™í‰ê· 
            ma_data = self.calculate_moving_averages(symbol)
            if not ma_data.empty:
                ma_cols = [col for col in ma_data.columns if col.startswith(('sma_', 'ema_'))]
                df = df.merge(ma_data[['date'] + ma_cols], on='date', how='left')
            
            # ìµœì‹  ë°ì´í„°ë§Œ ë°˜í™˜ (ê¸°ìˆ ì  ì§€í‘œê°€ ê³„ì‚°ëœ ë°ì´í„°)
            result = df.dropna().tail(1).to_dict('records')
            
            return result[0] if result else {}
            
        except Exception as e:
            print(f"âŒ ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚° ì‹¤íŒ¨ ({symbol}): {str(e)}")
            return {}
    
    def save_indicators_to_db(self, symbol: str) -> bool:
        """
        ê³„ì‚°ëœ ê¸°ìˆ ì  ì§€í‘œë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
        
        Args:
            symbol: ì¢…ëª© ì‹¬ë³¼
            
        Returns:
            ì €ì¥ ì„±ê³µ ì—¬ë¶€
        """
        try:
            indicators = self.calculate_all_indicators(symbol)
            
            if not indicators:
                return False
            
            # ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
            self.db.save_technical_indicators(indicators)
            self.db.conn.commit()
            
            print(f"âœ… {symbol} ê¸°ìˆ ì  ì§€í‘œ ì €ì¥ ì™„ë£Œ")
            return True
            
        except Exception as e:
            print(f"âŒ {symbol} ê¸°ìˆ ì  ì§€í‘œ ì €ì¥ ì‹¤íŒ¨: {str(e)}")
            return False
    
    def batch_calculate_indicators(self, symbols: List[str] = None) -> Dict[str, bool]:
        """
        ì—¬ëŸ¬ ì¢…ëª©ì˜ ê¸°ìˆ ì  ì§€í‘œë¥¼ ì¼ê´„ ê³„ì‚°
        
        Args:
            symbols: ì¢…ëª© ì‹¬ë³¼ ë¦¬ìŠ¤íŠ¸ (Noneì´ë©´ ì „ì²´ ì¢…ëª©)
            
        Returns:
            ì¢…ëª©ë³„ ì²˜ë¦¬ ê²°ê³¼
        """
        if symbols is None:
            symbols = self.db.get_active_symbols()
        
        results = {}
        
        for symbol in symbols:
            try:
                results[symbol] = self.save_indicators_to_db(symbol)
            except Exception as e:
                print(f"âŒ {symbol} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {str(e)}")
                results[symbol] = False
        
        success_count = sum(1 for success in results.values() if success)
        total_count = len(results)
        
        print(f"ğŸ“Š ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚° ì™„ë£Œ: {success_count}/{total_count} ì¢…ëª© ì„±ê³µ")
        
        return results
    
    def close(self):
        """ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¢…ë£Œ"""
        self.db.close()

# Airflow í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œ ì‚¬ìš©í•  ë•Œ í•„ìš”í•œ í•¨ìˆ˜ë“¤
def calculate_technical_indicators_task(symbol: str, **context):
    """Airflow íƒœìŠ¤í¬ìš© ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚° í•¨ìˆ˜"""
    ti = TechnicalIndicators()
    try:
        result = ti.save_indicators_to_db(symbol)
        return f"{'âœ… ì„±ê³µ' if result else 'âŒ ì‹¤íŒ¨'}: {symbol}"
    finally:
        ti.close()

def batch_calculate_indicators_task(**context):
    """Airflow íƒœìŠ¤í¬ìš© ì¼ê´„ ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚° í•¨ìˆ˜"""
    ti = TechnicalIndicators()
    try:
        results = ti.batch_calculate_indicators()
        success_count = sum(1 for success in results.values() if success)
        total_count = len(results)
        
        context['task_instance'].xcom_push(key='success_count', value=success_count)
        context['task_instance'].xcom_push(key='total_count', value=total_count)
        
        return f"ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚° ì™„ë£Œ: {success_count}/{total_count} ì¢…ëª© ì„±ê³µ"
    finally:
        ti.close()
