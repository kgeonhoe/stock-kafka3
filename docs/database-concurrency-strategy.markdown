# DuckDB ë™ì‹œì„± ë¬¸ì œ í•´ê²°: ì½ê¸° ì „ìš© ë³µì œë³¸(Read Replica) ì „ëµ

## ğŸ“‹ ëª©ì°¨
- [ë¬¸ì œ ìƒí™©](#ë¬¸ì œ-ìƒí™©)
- [ì „ëµ ê°œìš”](#ì „ëµ-ê°œìš”)
- [êµ¬í˜„ ìƒì„¸](#êµ¬í˜„-ìƒì„¸)
- [ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜](#ì‹œìŠ¤í…œ-ì•„í‚¤í…ì²˜)
- [ì•ˆì „ì„± ë³´ì¥](#ì•ˆì „ì„±-ë³´ì¥)
- [ì„±ëŠ¥ ë° íš¨ê³¼](#ì„±ëŠ¥-ë°-íš¨ê³¼)
- [íŠ¸ëŸ¬ë¸”ìŠˆíŒ…](#íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)

---

## ğŸš¨ ë¬¸ì œ ìƒí™©

### ê¸°ì¡´ ì•„í‚¤í…ì²˜ì˜ ë™ì‹œì„± ë¬¸ì œ

ë³¸ í”„ë¡œì íŠ¸ëŠ” **ì‹¤ì‹œê°„ Kafka í”„ë¡œë“€ì„œ**ì™€ **ë°°ì¹˜ ì²˜ë¦¬ìš© Airflow DAG**ê°€ ë™ì‹œì— ë™ì¼í•œ DuckDB íŒŒì¼(`stock_data.db`)ì— ì ‘ê·¼í•˜ëŠ” êµ¬ì¡°ì˜€ìŠµë‹ˆë‹¤.

```mermaid
graph LR
    A[Kafka Producer] --> C[stock_data.db]
    B[Airflow DAG] --> C
    C --> D[âŒ Lock Conflict]
```

**ë°œìƒí•œ ë¬¸ì œ:**
- **íŒŒì¼ ì ê¸ˆ ì¶©ëŒ**: Airflowê°€ ë°ì´í„°ë¥¼ ì“°ëŠ” ë™ì•ˆ Kafka í”„ë¡œë“€ì„œì˜ ì½ê¸° ìš”ì²­ì´ `IOException: Cannot acquire lock` ì˜¤ë¥˜ë¡œ ê±°ë¶€ë¨
- **ì„œë¹„ìŠ¤ ì¤‘ë‹¨**: í”„ë¡œë“€ì„œê°€ ì‹¤ì‹œê°„ ê´€ì‹¬ì¢…ëª© ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í•´ ë°ì´í„° ìˆ˜ì§‘ì´ ì¤‘ë‹¨ë¨
- **ë°ì´í„° ì¼ê´€ì„± ìœ„í—˜**: ì¤‘ê°„ì— ì¤‘ë‹¨ëœ ì“°ê¸° ì‘ì—…ìœ¼ë¡œ ì¸í•œ ë¶ˆì™„ì „í•œ ë°ì´í„° ìœ„í—˜

### DuckDBì˜ íŠ¹ì„±ìƒ ì œì•½

DuckDBëŠ” **In-Process** ë°ì´í„°ë² ì´ìŠ¤ë¡œ, ë³„ë„ì˜ ì„œë²„ ì—†ì´ ë§¤ìš° ë¹ ë¥¸ ì„±ëŠ¥ì„ ì œê³µí•˜ì§€ë§Œ:
- **ë‹¨ì¼ ì“°ê¸° ì›ì¹™**: í•œ ë²ˆì— í•˜ë‚˜ì˜ í”„ë¡œì„¸ìŠ¤ë§Œ ì“°ê¸° ì‘ì—… ê°€ëŠ¥
- **ì“°ê¸° ì¤‘ ì½ê¸° ì°¨ë‹¨**: ì“°ê¸° ì‘ì—… ì¤‘ì—ëŠ” ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ì˜ ì½ê¸°ë„ ì°¨ë‹¨ë¨

---

## ğŸ’¡ ì „ëµ ê°œìš”

### ì½ê¸° ì „ìš© ë³µì œë³¸(Read Replica) íŒ¨í„´

**í•µì‹¬ ì•„ì´ë””ì–´**: ì½ê¸°ì™€ ì“°ê¸° ì‘ì—…ì„ **ë¬¼ë¦¬ì ìœ¼ë¡œ ë¶„ë¦¬**í•˜ì—¬ ë™ì‹œì„± ë¬¸ì œë¥¼ ì›ì²œ ì°¨ë‹¨

```mermaid
graph TB
    subgraph "Airflow (Writer)"
        A1[nasdaq_daily_pipeline]
        A2[collect_symbols]
        A3[collect_ohlcv]
        A4[calculate_indicators]
        A5[create_replica]
        A6[trigger_next_dag]
        A1 --> A2 --> A3 --> A4 --> A5 --> A6
    end
    
    subgraph "Data Flow"
        B1[stock_data.db<br/>ë§ˆìŠ¤í„°]
        B2[stock_data_replica.db<br/>ë³µì œë³¸]
        B1 -.->|ì›ìì  ë³µì‚¬| B2
    end
    
    subgraph "Kafka Producer (Reader)"
        C1[multi_source_producer]
        C2[watchlist ì¡°íšŒ]
        C1 --> C2
    end
    
    A5 --> B1
    B1 --> B2
    B2 --> C2
    
    style B1 fill:#ff9999
    style B2 fill:#99ccff
    style A5 fill:#99ff99
```

### ì „ëµì˜ í•µì‹¬ êµ¬ì„± ìš”ì†Œ

1. **ë§ˆìŠ¤í„° DB** (`stock_data.db`): Airflowê°€ ë…ì ì ìœ¼ë¡œ ì“°ê¸° ì‘ì—… ìˆ˜í–‰
2. **ë³µì œë³¸ DB** (`stock_data_replica.db`): Kafka í”„ë¡œë“€ì„œê°€ ì½ê¸° ì „ìš©ìœ¼ë¡œ ì‚¬ìš©
3. **ì›ìì  ë³µì œ**: ì„ì‹œ íŒŒì¼ â†’ ì´ë¦„ ë³€ê²½ ë°©ì‹ìœ¼ë¡œ ì•ˆì „í•œ íŒŒì¼ êµì²´
4. **ë°©ì–´ì  ì½ê¸°**: ë³µì œë³¸ êµì²´ ì¤‘ì—ë„ ì•ˆì •ì„±ì„ ë³´ì¥í•˜ëŠ” ì˜¤ë¥˜ ì²˜ë¦¬

---

## ğŸ”§ êµ¬í˜„ ìƒì„¸

### 1. DuckDBManager ìˆ˜ì •: read_only ëª¨ë“œ ì§€ì›

```python
class DuckDBManager:
    def __init__(self, db_path: str = "/data/duckdb/stock_data.db", read_only: bool = False):
        """
        Args:
            db_path: DuckDB íŒŒì¼ ê²½ë¡œ
            read_only: ì½ê¸° ì „ìš© ëª¨ë“œë¡œ ì—°ê²°í• ì§€ ì—¬ë¶€
        """
        self.db_path = db_path
        os.makedirs(os.path.dirname(db_path), exist_ok=True)
        
        # ì½ê¸° ì „ìš© ëª¨ë“œ ì—°ê²°
        self.conn = duckdb.connect(database=db_path, read_only=read_only)
        
        if not read_only:
            self._create_tables()
```

**ì¥ì :**
- ì‹¤ìˆ˜ë¡œ ì½ê¸° ì „ìš© í´ë¼ì´ì–¸íŠ¸ê°€ ì“°ê¸°ë¥¼ ì‹œë„í•˜ëŠ” ê²ƒì„ ë°©ì§€
- ì½”ë“œ ë ˆë²¨ì—ì„œ ì—­í•  ë¶„ë¦¬ë¥¼ ëª…í™•íˆ í•¨

### 2. Airflow DAG: ì›ìì  ë³µì œë³¸ ìƒì„± íƒœìŠ¤í¬

```python
def create_db_replica_func():
    """
    ì›ìì  ì—°ì‚°ì„ ìœ„í•´ ì„ì‹œ íŒŒì¼ ì‚¬ìš© í›„ ì´ë¦„ ë³€ê²½ ì „ëµì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    """
    master_db_path = "/data/duckdb/stock_data.db"
    replica_db_path = "/data/duckdb/stock_data_replica.db"
    temp_replica_path = replica_db_path + ".tmp"

    try:
        # 1. ë§ˆìŠ¤í„° DBë¥¼ ì„ì‹œ íŒŒì¼ë¡œ ì•ˆì „í•˜ê²Œ ë³µì‚¬
        shutil.copy2(master_db_path, temp_replica_path)
        
        # 2. ë³µì‚¬ê°€ ì™„ë£Œë˜ë©´, ì›ìì  ì—°ì‚°ìœ¼ë¡œ íŒŒì¼ ì´ë¦„ ë³€ê²½
        os.rename(temp_replica_path, replica_db_path)
        
    except Exception as e:
        # ì‹¤íŒ¨ ì‹œ ì„ì‹œ íŒŒì¼ ì •ë¦¬
        if os.path.exists(temp_replica_path):
            os.remove(temp_replica_path)
        raise
```

**í•µì‹¬ ê¸°ìˆ :**
- **ì„ì‹œ íŒŒì¼ ì‚¬ìš©**: ë³µì‚¬ ì¤‘ì— ê¸°ì¡´ ë³µì œë³¸ì— ì˜í–¥ ì—†ìŒ
- **os.rename()**: Linuxì—ì„œ ì›ìì  ì—°ì‚°ìœ¼ë¡œ ë™ì‘
- **ì˜ˆì™¸ ì²˜ë¦¬**: ì‹¤íŒ¨ ì‹œ ì„ì‹œ íŒŒì¼ ìë™ ì •ë¦¬

### 3. Kafka í”„ë¡œë“€ì„œ: ì•ˆì „í•œ ë³µì œë³¸ ì½ê¸°

```python
def _load_watchlist_from_db(self) -> list:
    """
    íŒŒì¼ì´ êµì²´ë˜ëŠ” ìˆœê°„ì— ë°œìƒí•  ìˆ˜ ìˆëŠ” ì˜¤ë¥˜ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
    """
    try:
        # ë³µì œë³¸ì—ì„œ ë°ì´í„° ì½ê¸° ì‹œë„
        result = self.db_manager.execute_query(query)
        if result and len(result) > 0:
            return [row[0] for row in result]
        else:
            return getattr(self, 'nasdaq_symbols', self._get_default_symbols())
            
    except Exception as e:
        # íŒŒì¼ êµì²´ ì¤‘ ì¼ì‹œì  ì˜¤ë¥˜ ë°œìƒ ì‹œ ì´ì „ ë°ì´í„° ì‚¬ìš©
        print(f"âš ï¸ ì¼ì‹œì  ì˜¤ë¥˜ ë°œìƒ: {e}")
        return getattr(self, 'nasdaq_symbols', self._get_default_symbols())
```

**ì•ˆì „ì¥ì¹˜:**
- **ì´ì „ ë°ì´í„° ìœ ì§€**: ì½ê¸° ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ ë©”ëª¨ë¦¬ì˜ ê´€ì‹¬ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ì‚¬ìš©
- **ê¸°ë³¸ê°’ ì œê³µ**: ì´ˆê¸° ì‹¤í–‰ì‹œ ë°ì´í„°ê°€ ì—†ì–´ë„ ê¸°ë³¸ ì¢…ëª©ìœ¼ë¡œ ì‹œì‘
- **ì§€ì†ì  ì‹œë„**: ë‹¤ìŒ ì£¼ê¸°ì— ë‹¤ì‹œ ì½ê¸° ì‹œë„

---

## ğŸ—ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### ì „ì²´ ë°ì´í„° íë¦„

```mermaid
sequenceDiagram
    participant A as Airflow DAG
    participant M as stock_data.db<br/>(Master)
    participant R as stock_data_replica.db<br/>(Replica)
    participant K as Kafka Producer
    
    Note over A,K: ì¼ì¼ ë°°ì¹˜ ì²˜ë¦¬ ì‹œì‘
    A->>M: 1. ë‚˜ìŠ¤ë‹¥ ì‹¬ë³¼ ìˆ˜ì§‘
    A->>M: 2. ì£¼ê°€ ë°ì´í„° ìˆ˜ì§‘
    A->>M: 3. ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚°
    
    Note over A,R: ë³µì œë³¸ ìƒì„± (ì›ìì )
    A->>R: 4. ì„ì‹œíŒŒì¼.tmp ìƒì„±
    A->>R: 5. ì›ìì  ì´ë¦„ ë³€ê²½
    
    Note over K: ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì§‘
    K->>R: 6. ê´€ì‹¬ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ
    K->>K: 7. ì‹¤ì‹œê°„ ì£¼ê°€ ìˆ˜ì§‘
    
    Note over A,K: ë‹¤ìŒ ë‚  ë°°ì¹˜ ì²˜ë¦¬
    A->>M: 8. ìƒˆë¡œìš´ ë°°ì¹˜ ì‘ì—…
    A->>R: 9. ë³µì œë³¸ ì—…ë°ì´íŠ¸
```

### íŒŒì¼ ì‹œìŠ¤í…œ ë ˆì´ì•„ì›ƒ

```
/data/duckdb/
â”œâ”€â”€ stock_data.db           # ë§ˆìŠ¤í„° (Airflow ì“°ê¸° ì „ìš©)
â”œâ”€â”€ stock_data_replica.db   # ë³µì œë³¸ (Producer ì½ê¸° ì „ìš©)
â””â”€â”€ stock_data_replica.db.tmp  # ì„ì‹œ íŒŒì¼ (ë³µì œ ì¤‘ì—ë§Œ ì¡´ì¬)
```

---

## ğŸ›¡ï¸ ì•ˆì „ì„± ë³´ì¥

### 1. ì›ìì  íŒŒì¼ êµì²´

**ë¬¸ì œ**: íŒŒì¼ ë³µì‚¬ ì¤‘ì— í”„ë¡œë“€ì„œê°€ ì ‘ê·¼í•˜ë©´ ë¶ˆì™„ì „í•œ ë°ì´í„°ë¥¼ ì½ì„ ìœ„í—˜

**í•´ê²°**:
```bash
# ì•ˆì „í•˜ì§€ ì•Šì€ ë°©ë²•
cp stock_data.db stock_data_replica.db  # ë³µì‚¬ ì¤‘ ì ‘ê·¼ ê°€ëŠ¥

# ì•ˆì „í•œ ë°©ë²• (ì›ìì )
cp stock_data.db stock_data_replica.db.tmp  # ì„ì‹œ íŒŒì¼ë¡œ ë³µì‚¬
mv stock_data_replica.db.tmp stock_data_replica.db  # ì›ìì  ì´ë¦„ ë³€ê²½
```

**ì›ìì  ì—°ì‚°ì˜ ë³´ì¥**:
- `os.rename()`ì€ Linuxì—ì„œ ë‹¨ì¼ ì‹œìŠ¤í…œ ì½œë¡œ ì²˜ë¦¬
- íŒŒì¼ ì‹œìŠ¤í…œ ë ˆë²¨ì—ì„œ ì¤‘ê°„ ìƒíƒœê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ
- í”„ë¡œë“€ì„œëŠ” ì™„ì „í•œ ì´ì „ íŒŒì¼ ë˜ëŠ” ì™„ì „í•œ ìƒˆ íŒŒì¼ë§Œ ë³¼ ìˆ˜ ìˆìŒ

### 2. ë°©ì–´ì  í”„ë¡œê·¸ë˜ë°

**Kafka í”„ë¡œë“€ì„œì˜ ë‹¤ì¤‘ ë³´í˜¸ë§‰**:

1. **1ì°¨ ë°©ì–´**: ì´ì „ ë°ì´í„° ìœ ì§€
   ```python
   return getattr(self, 'nasdaq_symbols', self._get_default_symbols())
   ```

2. **2ì°¨ ë°©ì–´**: ê¸°ë³¸ ì¢…ëª© ì œê³µ
   ```python
   def _get_default_symbols(self) -> list:
       return ['AAPL', 'MSFT', 'GOOGL', ...]  # í•­ìƒ ì‚¬ìš© ê°€ëŠ¥í•œ ê¸°ë³¸ ëª©ë¡
   ```

3. **3ì°¨ ë°©ì–´**: ì£¼ê¸°ì  ì¬ì‹œë„
   ```python
   # 10 ì‚¬ì´í´ë§ˆë‹¤ watchlist ìƒˆë¡œê³ ì¹¨ ì‹œë„
   if cycle_count % watchlist_refresh_interval == 0:
       self.refresh_watchlist()
   ```

### 3. ì¥ì•  ë³µêµ¬ ì‹œë‚˜ë¦¬ì˜¤

| ìƒí™© | í”„ë¡œë“€ì„œ ë™ì‘ | ë³µêµ¬ ë°©ë²• |
|------|---------------|-----------|
| ë³µì œë³¸ íŒŒì¼ ì—†ìŒ | ê¸°ë³¸ ì¢…ëª©ìœ¼ë¡œ ê³„ì† ë™ì‘ | ë‹¤ìŒ Airflow ì‹¤í–‰ ì‹œ ìë™ ìƒì„± |
| ë³µì œë³¸ ì†ìƒ | ì´ì „ ë©”ëª¨ë¦¬ ë°ì´í„° ì‚¬ìš© | Airflow ì¬ì‹¤í–‰ìœ¼ë¡œ ìƒˆ ë³µì œë³¸ ìƒì„± |
| íŒŒì¼ êµì²´ ì¤‘ ì ‘ê·¼ | ì¼ì‹œì  ì˜¤ë¥˜ í›„ ì¬ì‹œë„ | ë‹¤ìŒ ì£¼ê¸°ì— ìë™ ë³µêµ¬ |
| DuckDB ì—°ê²° ì‹¤íŒ¨ | ê¸°ë³¸ ì¢…ëª©ìœ¼ë¡œ fallback | ì‹œìŠ¤í…œ ë³µêµ¬ í›„ ìë™ ì—°ê²° |

---

## ğŸ“Š ì„±ëŠ¥ ë° íš¨ê³¼

### Before vs After ë¹„êµ

| ì¸¡ë©´ | ê¸°ì¡´ ë°©ì‹ | Read Replica ë°©ì‹ |
|------|-----------|-------------------|
| **ë™ì‹œì„± ë¬¸ì œ** | âŒ ë¹ˆë²ˆí•œ Lock ì¶©ëŒ | âœ… ì™„ì „ í•´ê²° |
| **ì„œë¹„ìŠ¤ ì•ˆì •ì„±** | âŒ ê°„í—ì  ì¤‘ë‹¨ | âœ… ë¬´ì¤‘ë‹¨ ìš´ì˜ |
| **ì½”ë“œ ë³µì¡ì„±** | ğŸ”¶ ì¬ì‹œë„/ëŒ€ê¸° ë¡œì§ í•„ìš” | âœ… ë‹¨ìˆœí•˜ê³  ëª…í™• |
| **ë°ì´í„° ì¼ê´€ì„±** | âŒ ì¤‘ê°„ ìƒíƒœ ë…¸ì¶œ ìœ„í—˜ | âœ… ì›ìì  ì—…ë°ì´íŠ¸ |
| **í™•ì¥ì„±** | âŒ ë™ì‹œ ì ‘ê·¼ í´ë¼ì´ì–¸íŠ¸ ì œí•œ | âœ… ì½ê¸° í´ë¼ì´ì–¸íŠ¸ ë¬´ì œí•œ í™•ì¥ |

### ì„±ëŠ¥ íŠ¹ì„±

**ì§€ì—°ì‹œê°„ (Latency)**:
- **ì½ê¸° ì‘ì—…**: 0ms ì¶”ê°€ ì§€ì—° (ë¡œì»¬ íŒŒì¼ ì ‘ê·¼)
- **ë³µì œ ì‘ì—…**: íŒŒì¼ í¬ê¸°ì— ë¹„ë¡€ (~5-10ì´ˆ, 100MB ê¸°ì¤€)
- **ë°ì´í„° ì‹ ì„ ë„**: ìµœëŒ€ 24ì‹œê°„ (ë°°ì¹˜ ì£¼ê¸°ì— ë”°ë¼)

**ì²˜ë¦¬ëŸ‰ (Throughput)**:
- **ì½ê¸°**: ì›ë³¸ê³¼ ë™ì¼í•œ ì„±ëŠ¥
- **ì“°ê¸°**: ì˜í–¥ ì—†ìŒ (ë…ë¦½ì  ìˆ˜í–‰)
- **ì‹œìŠ¤í…œ ìì›**: ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ 2ë°°, CPU/ë©”ëª¨ë¦¬ ì˜í–¥ ë¯¸ë¯¸

### ë¹„ìš©-íš¨ê³¼ ë¶„ì„

**ì¶”ê°€ ë¹„ìš©**:
- ë””ìŠ¤í¬ ê³µê°„: 2ë°° (ì¼ë°˜ì ìœ¼ë¡œ 100-500MB ìˆ˜ì¤€ìœ¼ë¡œ ë¯¸ë¯¸)
- ë³µì œ ì‹œê°„: ë°°ì¹˜ ì‘ì—…ì— 5-10ì´ˆ ì¶”ê°€

**ì ˆì•½ íš¨ê³¼**:
- ê°œë°œ/ìš´ì˜ ì‹œê°„: ë™ì‹œì„± ë¬¸ì œ ë””ë²„ê¹… ì‹œê°„ ëŒ€í­ ì ˆì•½
- ì‹œìŠ¤í…œ ì•ˆì •ì„±: ì„œë¹„ìŠ¤ ì¤‘ë‹¨ìœ¼ë¡œ ì¸í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ì†ì‹¤ ë°©ì§€
- í™•ì¥ì„±: í–¥í›„ ì½ê¸° í´ë¼ì´ì–¸íŠ¸ ì¶”ê°€ ì‹œ ì¶”ê°€ ì‘ì—… ë¶ˆí•„ìš”

---

## ğŸ”§ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ìì£¼ ë°œìƒí•˜ëŠ” ë¬¸ì œì™€ í•´ê²°ë²•

#### 1. ë³µì œë³¸ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•ŠìŒ

**ì¦ìƒ**:
```
âš ï¸ DuckDB watchlist ì¡°íšŒ ì¤‘ ì¼ì‹œì  ì˜¤ë¥˜ ë°œìƒ: no such file: /data/duckdb/stock_data_replica.db
```

**ì›ì¸**: Airflow DAGì˜ ë³µì œ íƒœìŠ¤í¬ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì‹¤íŒ¨

**í•´ê²°ë²•**:
```bash
# 1. Airflow DAG ìƒíƒœ í™•ì¸
docker compose exec airflow-scheduler airflow dags state nasdaq_daily_pipeline

# 2. ìˆ˜ë™ìœ¼ë¡œ ë³µì œë³¸ ìƒì„±
docker compose exec airflow-scheduler python -c "
import shutil
shutil.copy2('/data/duckdb/stock_data.db', '/data/duckdb/stock_data_replica.db')
print('ë³µì œë³¸ ìˆ˜ë™ ìƒì„± ì™„ë£Œ')
"
```

#### 2. ë³µì œ ì¤‘ í”„ë¡œë“€ì„œ ì˜¤ë¥˜

**ì¦ìƒ**:
```
âš ï¸ watchlist ìƒˆë¡œê³ ì¹¨ ì¤‘ ì¼ì‹œì  ì˜¤ë¥˜: database is locked
```

**ì›ì¸**: ë§¤ìš° ë“œë¬¼ê²Œ `os.rename()` ì¤‘ì— ì ‘ê·¼ ì‹œë„

**í•´ê²°ë²•**: ìë™ ë³µêµ¬ë¨ (ë‹¤ìŒ ì£¼ê¸°ì— ì •ìƒ ë™ì‘)
- ìˆ˜ë™ ê°œì… ë¶ˆí•„ìš”
- ì´ì „ ë°ì´í„°ë¡œ ê³„ì† ë™ì‘í•˜ë¯€ë¡œ ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ì—†ìŒ

#### 3. ë””ìŠ¤í¬ ê³µê°„ ë¶€ì¡±

**ì¦ìƒ**:
```
âŒ DB ë³µì œë³¸ ìƒì„± ì‹¤íŒ¨: [Errno 28] No space left on device
```

**í•´ê²°ë²•**:
```bash
# 1. ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸
df -h /data

# 2. ì˜¤ë˜ëœ ë¡œê·¸ íŒŒì¼ ì •ë¦¬
find /data -name "*.log" -mtime +30 -delete

# 3. ì„ì‹œ íŒŒì¼ ì •ë¦¬
rm -f /data/duckdb/*.tmp
```

#### 4. ê¶Œí•œ ë¬¸ì œ

**ì¦ìƒ**:
```
âŒ DB ë³µì œë³¸ ìƒì„± ì‹¤íŒ¨: [Errno 13] Permission denied
```

**í•´ê²°ë²•**:
```bash
# ë°ì´í„° ë””ë ‰í† ë¦¬ ê¶Œí•œ ìˆ˜ì •
sudo chown -R 50000:0 /data/duckdb
sudo chmod -R 755 /data/duckdb
```

### ëª¨ë‹ˆí„°ë§ ë° ê±´ê°•ì„± í™•ì¸

#### ë³µì œë³¸ ìƒíƒœ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸

```bash
#!/bin/bash
# check_replica_health.sh

MASTER="/data/duckdb/stock_data.db"
REPLICA="/data/duckdb/stock_data_replica.db"

echo "=== DuckDB Read Replica ìƒíƒœ í™•ì¸ ==="

# íŒŒì¼ ì¡´ì¬ ì—¬ë¶€
if [[ -f "$MASTER" ]]; then
    echo "âœ… ë§ˆìŠ¤í„° DB ì¡´ì¬: $(ls -lh $MASTER)"
else
    echo "âŒ ë§ˆìŠ¤í„° DB ì—†ìŒ: $MASTER"
fi

if [[ -f "$REPLICA" ]]; then
    echo "âœ… ë³µì œë³¸ DB ì¡´ì¬: $(ls -lh $REPLICA)"
else
    echo "âŒ ë³µì œë³¸ DB ì—†ìŒ: $REPLICA"
fi

# ë°ì´í„° ë™ê¸°í™” ìƒíƒœ (í¬ê¸° ë¹„êµ)
if [[ -f "$MASTER" && -f "$REPLICA" ]]; then
    MASTER_SIZE=$(stat -f%z "$MASTER" 2>/dev/null || stat -c%s "$MASTER")
    REPLICA_SIZE=$(stat -f%z "$REPLICA" 2>/dev/null || stat -c%s "$REPLICA")
    
    if [[ $MASTER_SIZE -eq $REPLICA_SIZE ]]; then
        echo "âœ… í¬ê¸° ë™ì¼: ë§ˆìŠ¤í„°ì™€ ë³µì œë³¸ì´ ë™ê¸°í™”ë¨"
    else
        echo "âš ï¸ í¬ê¸° ì°¨ì´: ë§ˆìŠ¤í„°=$MASTER_SIZE, ë³µì œë³¸=$REPLICA_SIZE"
    fi
fi

echo "=== ì™„ë£Œ ==="
```

---

## ğŸ“š ì°¸ê³  ìë£Œ

### ê´€ë ¨ ë¬¸ì„œ
- [DuckDB ê³µì‹ ë¬¸ì„œ - Concurrency](https://duckdb.org/docs/connect/concurrency)
- [Database Replication Patterns](https://martinfowler.com/articles/patterns-of-distributed-systems/read-replicas.html)
- [Atomic File Operations in Unix](https://lwn.net/Articles/457667/)

### í”„ë¡œì íŠ¸ ë‚´ ê´€ë ¨ íŒŒì¼
- `common/database.py` - DuckDBManager í´ë˜ìŠ¤
- `kafka/multi_source_producer.py` - Kafka í”„ë¡œë“€ì„œ
- `airflow/dags/nasdaq_daily_pipeline.py` - ë³µì œë³¸ ìƒì„± DAG
- `docker-compose.yml` - ì „ì²´ ì„œë¹„ìŠ¤ êµ¬ì„±

### ì¶”ê°€ ê°œì„  ì•„ì´ë””ì–´
1. **ì••ì¶•ëœ ë³µì œë³¸**: ì½ê¸° ì „ìš©ì´ë¯€ë¡œ ì••ì¶•í•˜ì—¬ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ì ˆì•½
2. **ì¦ë¶„ ë³µì œ**: ë³€ê²½ëœ ë¶€ë¶„ë§Œ ë³µì œí•˜ì—¬ ë³µì œ ì‹œê°„ ë‹¨ì¶•
3. **ë‹¤ì¤‘ ë³µì œë³¸**: ì§€ì—­ë³„ ë˜ëŠ” ìš©ë„ë³„ ë³µì œë³¸ ìƒì„±
4. **ìë™ ë³µêµ¬**: ë³µì œë³¸ ì†ìƒ ê°ì§€ ì‹œ ìë™ ì¬ìƒì„±

---

*ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: 2025ë…„ 7ì›” 24ì¼*
*ì‘ì„±ì: GitHub Copilot & ì‚¬ìš©ì*
